<a href="https://github.com/lucka-me/Patroute-web"><div align=center><img src="./Resource/Banner.svg" alt="PatroLine"></div></a>

<h1 align=center>使用手册</h1>

<p align=center>
    日期：2018年8月9日<br/>
    版本：1.4
</p>

## 前言
巡线 Patroute 是为管线巡检工作提供的，集巡检任务管理和巡线工作管理于一体的智能化管理系统。本手册旨在阐明该产品系统的组成及使用方法，为用户正确、合理的使用本产品提供必要的技术资料。

## 目录
- [软件概述](#软件概述)
    - [适用版本](#适用版本)
    - [系统要求](#系统要求)
    - [经过测试的浏览器和设备](#经过测试的浏览器和设备)
- [用户界面](#用户界面)
    - [Android 客户端](#Android-客户端)
    - [设置界面](#设置界面)
- [安装与部署](#安装与部署)
    - [FTP 服务器](#FTP-服务器)
    - [Web 工具](Web-工具)
    - [Android 客户端](Android-客户端)
- [使用流程](#使用流程)
    - [发布任务](#发布任务)
    - [执行任务](#执行任务)
        - [提交工单](#提交工单)
        - [反作弊](#反作弊)
    - [审核任务](#审核任务)

## 软件概述
巡线 Patroute 系统（以下简称 **Patroute**）由 FTP 服务器、Web 工具及 Android 客户端组成，其基本功能如下：

* FTP 服务器：存储巡线任务数据和文件。
* Web 工具：制作巡线任务和审核任务日志，由管理员使用。
* Android 客户端：获取巡线任务、管理巡线工作、生成和提交工单报告及记录和上传任务日志，由巡检员使用。

### 适用版本
本手册为当前最新版本软件编写，适用的软件版本如下：

| 名称 | 版本号
| :---: | :---
| 任务制作工具（Web） | `1.1.1`
| 任务审核工具（Web） | `1.0.2`
| Android 客户端 | `1.4.2`

### 系统要求
使用 Patroute 需要满足以下要求：

| 名称 | 系统要求
| :---: | :---
| Web 工具 | 支持 HTML 5 及 CSS 3 的现代浏览器<br/>互联网连接
| Android 客户端 | Android 5.0 或更高<br/>互联网连接<br/>GNSS 定位模块<br/>摄像头<br/>4GB 或以上存储空间

### 经过测试的浏览器和设备
以下浏览器和设备经测试可以正常运行 Patroute：

| 浏览器 | 版本 |
| :---: | :---:
| Safari | 11
| Chrome | 67

| 设备型号 | 系统版本 |
| :---: | :---:
| 华为 G7 Plus | Android 6.0.1<br/>EMUI 4.0.2
| 魅族 MX4 Pro | Android 5.1.1<br/>Flyme 6.3.0.2A

## 用户界面

### Web 工具
Patroute 的 Web 工具界面为两栏模式，左侧为地图视图，右侧为信息栏视图。

![](./Resource/Screenshot/Web-MAT-UI.png)

### Android 客户端
Patroute 的 Android 客户端界面简洁，采用标准的 Material Design 风格设计，主要包括主界面和设置界面。

| 主界面（显示地图） | 设置界面（部分）
| :---: | :---:
| ![](./Resource/Screenshot/App-Main-UI.png) | ![](./Resource/Screenshot/App-Preference-UI.png)

主界面由工具栏、列表视图及报告按钮组成。其中列表视图由以下三种卡片组成：

- **位置卡片**  
  始终显示。卡片内显示设备当前所在的经纬度或地图。
- **任务卡片**  
  仅在开始载入任务、任务正在进行时显示。当正在载入任务时卡片内显示载入动画；当任务正在进行时则显示任务进度，点击卡片将打开显示任务详情的对话框。
- **检查点卡片**  
  仅在任务正在进行时显示。卡片内显示检查点名称、距离和完成状态，点击卡片将打开显示检查点详情的对话框。

设置界面包括对软件各项参数的设置，包括以下类别和项目：

- **用户**：用户名、登陆密码
- **服务器**：服务器地址、服务器端口、服务器超时、启用加密协议、测试服务器
- **地图**：显示地图、地图类型

## 安装与部署
在使用 Patroute 前，必须安装和部署服务器、Web 工具和 Android 客户端。

### FTP 服务器
Patroute 支持标准的 FTP 服务器。用户可根据自身需求架设服务器，亦可使用 Python 和 pyftpdlib 架设测试用服务器。建议使用支持 FTPS 的服务器以通过 TLS/SSL 加密传输，保证数据安全。

服务器根目录下应有 `Mission` 文件夹，以及对应各个用户的用户名文件夹。

### Web 工具
Web 工具为独立网页应用，将文件夹拷贝至 HTTP 服务器即可通过浏览器访问。

### Android 客户端
将 APK 安装包分发至符合要求的目标设备上安装即可。

首次运行软件时应在设置界面中按系统管理员的要求设置用户名和密码、服务器地址、端口、超时和加密协议并测试服务器，若测试失败请联系管理员。

**针对 Android 6.0 或更高版本的设备：本软件首次运行时将请求位置权限及外部存储权限，用户应同意，否则软件将无法正确运行。**

## 使用流程
使用 Patroute 配合巡线工作需要遵循一定的使用流程。本系统主要面向巡线管理者及巡线工作者，以下分别简称为管理员和用户。

### 发布任务
管理员可使用 Web 工具中的 **巡线任务制作工具** 直接生成任务文件：

![](./Resource/Screenshot/Web-MAT-UI.png)

1. 填写任务编号、巡线员工用户名及任务描述。
2. 在地图上依次单击检查点所在位置。
3. 在列表卡片中填写各个检查点名称及描述。
4. 检查无误后，点击右上角的保持按钮，生成任务文件压缩包。

将任务文件解压至 FTP 服务器根目录，与 `Mission` 文件夹合并即可。

最后在 FTP 服务器根目录下建立 `<用户名>/<任务 ID>/` 文件夹供用户上传照片、报告和日志。

### 执行任务
用户在主页面菜单中点击「开始」，客户端随即连接服务器下载并解析任务文件。

任务文件解析完成后任务正式开始，客户端主界面将显示任务描述，任务卡片中会显示任务进度，其下方会列出各个检查点对应的卡片，用户可点击查看其具体的位置和描述。

客户端会以一定频率更新位置信息，用户应保持设备有良好的 GPS 信号（基于精度的考量，客户端不支持网络定位）。在用户接近检查点时，将弹出提示框提示用户检查，用户可选择正常或报告问题，两者均视为检查完毕，其中后者将打开照相机进入提交工单的流程。  
若软件未弹出提示框，用户也可点击相应的检查点卡片以完成检查。

当全部检查点均检查完毕后，任务对话框将弹出，用户可以选择结束任务。结束任务时软件将生成并上传任务日志文件 `<任务 ID>.log`。  
用户亦可随时在主页面菜单及任务对话框中结束任务。

#### 提交工单
用户在发现需要提交工单的问题时，可向服务器提交工单。

1. 点击主界面右下角的报告按钮，打开照相机。
2. 拍照，确认照片。
3. 显示工单对话框，添加问题描述。
4. 提交工单。

客户端将上传工单文件和照片至 FTP 服务器的 `<用户名>/<任务 ID>/` 文件夹中，管理员可据服务器提示信息进行后续的相关操作。

#### 反作弊
从 1.4 版开始，Android 客户端加入了反作弊机制（TrumeKit 模块），用于检测常见的模拟器、位置模拟和时间欺骗。

- **模拟器检测**  
  客户端启动时，TrumeKit 将检测设备是否为模拟器，若为模拟器将显示警告并强制退出。
- **位置模拟检测**  
  TrumeKit 会检测位置信息是否来自模拟位置，若为模拟位置将会显示警告，并在任务日志中记录相关信息。
- **时间欺骗检测**  
  TrumeKit 会每隔一段时间核对设备时间与互联网时间，若二者相差较大将会显示警告，并在任务日志中记录相关信息。

### 审核任务
管理员可通过 Web 工具中的 **巡线任务审核工具** 对任务日志文件进行审核。

Patroute 的日志模块会记录任务执行期间的信息，包括移动轨迹、检查记录、提交工单、运行情况、TrumeKit 检测到的模拟位置和时间欺骗及其对应的时间和位置。管理员可在审核工具中点击右上角的按钮打开 `.log` 文件，工具将解析日志内容，将其以地图和列表的形式展现出来。
